<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>פרטי הדיל - נופש לי ולך</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="container">
            <div id="branding">
                <h1><a href="index.html">✈️ נופש לי ולך</a></h1>
            </div>
            <nav>
                <ul>
                    <li><a href="index.html">דף הבית</a></li>
                    <li><a href="deals.html">כל הדילים</a></li>
                    <li><a href="admin.html">ניהול</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <section id="deal-details-page" class="container">
        <div class="deal-details-container">
            <h2 id="deal-title">טוען את פרטי הדיל...</h2>
            <img id="deal-image" src="https://via.placeholder.com/800x400?text=טוען+תמונה..." alt="תמונת הדיל">
            <p id="deal-description">תיאור מפורט של הדיל יופיע כאן.</p>
            <p id="deal-price" class="price">מחיר: <span id="price-value"></span></p>
            <p id="deal-type-display">סוג דיל: <span id="type-value"></span></p>

            <div id="booking-options">
                </div>
        </div>
    </section>

    <footer>
        <p>נופש לי ולך &copy; <span id="currentYear"></span></p>
    </footer>

    <script type="module">
        import { db } from './firebase-init.js';
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";

        document.getElementById('currentYear').textContent = new Date().getFullYear();

        const dealTitleEl = document.getElementById('deal-title');
        const dealImageEl = document.getElementById('deal-image');
        const dealDescriptionEl = document.getElementById('deal-description');
        const priceValueEl = document.getElementById('price-value');
        const typeValueEl = document.getElementById('type-value');
        const bookingOptionsContainer = document.getElementById('booking-options');

        async function fetchDealDetails() {
            const urlParams = new URLSearchParams(window.location.search);
            const dealId = urlParams.get('dealId');

            if (!dealId) {
                dealTitleEl.textContent = "דיל לא נמצא";
                dealDescriptionEl.textContent = "אנא חזור לדף הדילים ובחר דיל.";
                dealImageEl.style.display = 'none';
                return;
            }

            try {
                const dealRef = doc(db, "deals", dealId);
                const docSnap = await getDoc(dealRef);

                if (docSnap.exists()) {
                    const deal = docSnap.data();
                    dealTitleEl.textContent = deal.name;
                    dealImageEl.src = deal.imageUrl || 'https://via.placeholder.com/800x400?text=תמונה+לא+זמינה';
                    dealImageEl.alt = deal.name;
                    dealDescriptionEl.innerHTML = deal.description.replace(/\n/g, '<br>'); // תומך בשורות חדשות בתיאור
                    priceValueEl.textContent = deal.price_text;
                    typeValueEl.textContent = getDealTypeDisplay(deal.type);

                    bookingOptionsContainer.innerHTML = ''; // נקה אפשרויות קודמות

                    // לוגיקת הצגת כפתורים לפי סוג הדיל
                    if (deal.type === 'flight') {
                        bookingOptionsContainer.innerHTML = `
                            <h4>פרטי יצירת קשר להזמנת טיסה:</h4>
                            <p>להזמנת טיסה זו, אנא פנה אלינו ישירות. אנו נסגור עבורך את ההזמנה בעמלה של 100 ₪ או 5% ממחיר הטיסה (הנמוך מביניהם).</p>
                            <a href="mailto:your-email@example.com?subject=הזמנת טיסה: ${deal.name}" class="button">פנה אליי לסגירת ההזמנה</a>
                        `;
                    } else if (deal.type === 'hotel') {
                        let affiliateButtonsHTML = '';
                        if (deal.affiliateLinks?.booking) {
                            affiliateButtonsHTML += `<a href="${deal.affiliateLinks.booking}" target="_blank" class="button">הזמן לבד דרך Booking.com</a>`;
                        }
                        if (deal.affiliateLinks?.agoda) {
                            affiliateButtonsHTML += `<a href="${deal.affiliateLinks.agoda}" target="_blank" class="button button-secondary">הזמן לבד דרך Agoda</a>`;
                        }
                        if (deal.affiliateLinks?.expedia) {
                            affiliateButtonsHTML += `<a href="${deal.affiliateLinks.expedia}" target="_blank" class="button">הזמן לבד דרך Expedia</a>`;
                        }

                        bookingOptionsContainer.innerHTML = `
                            <h4>אפשרויות הזמנה למלון:</h4>
                            <p><strong>אפשרות 1: הזמנה עצמאית</strong> (אנחנו מקבלים עמלה קטנה מהשותפים ללא תוספת עלות עבורך)</p>
                            ${affiliateButtonsHTML || '<p>אין כרגע קישורי שותפים זמינים למלון זה.</p>'}
                            <hr style="margin: 20px 0;">
                            <p><strong>אפשרות 2: שירות אישי שלנו</strong></p>
                            <p>פנה אלינו לסגירה אישית של המלון בעמלה של 100 ₪ או 5% ממחיר המלון (הנמוך מביניהם).</p>
                            <a href="mailto:your-email@example.com?subject=הזמנת מלון: ${deal.name}" class="button">בקש ממני לסגור לך</a>
                        `;
                    } else if (deal.type === 'package') {
                         bookingOptionsContainer.innerHTML = `
                            <h4>פרטי יצירת קשר להזמנת חבילה:</h4>
                            <p>להזמנת חבילה זו (טיסה + מלון), אנא פנה אלינו ישירות. אנו נסגור עבורך את ההזמנה בעמלה כוללת של 100 ₪ או 5% מהמחיר הכולל של החבילה.</p>
                            <a href="mailto:your-email@example.com?subject=הזמנת חבילה: ${deal.name}" class="button">פנה אליי לסגירת החבילה</a>
                        `;
                    }

                } else {
                    dealTitleEl.textContent = "דיל לא נמצא";
                    dealDescriptionEl.textContent = "לא הצלחנו למצוא את פרטי הדיל המבוקש.";
                    dealImageEl.style.display = 'none';
                }
            } catch (error) {
                console.error("Error fetching deal details: ", error);
                dealTitleEl.textContent = "שגיאה בטעינת הדיל";
                dealDescriptionEl.textContent = "אירעה שגיאה. נסה לרענן את הדף.";
                dealImageEl.style.display = 'none';
            }
        }

        function getDealTypeDisplay(typeKey) {
            if (typeKey === 'flight') return 'טיסה';
            if (typeKey === 'hotel') return 'מלון';
            if (typeKey === 'package') return 'חבילה';
            return typeKey;
        }

        fetchDealDetails();
    </script>
</body>
</html>
