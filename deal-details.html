<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>פרטי הדיל - נופש לי ולך</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* סגנונות נוספים לדף פרטי דיל */
        .deal-meta-section { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--medium-gray); }
        .deal-meta-section h4 { color: var(--secondary-color); margin-bottom: 8px; }
        .deal-meta-section ul { list-style: none; padding-right: 0; margin:0; } /* שינוי ל-padding-right */
        .deal-meta-section ul li { background-color: var(--light-gray); padding: 5px 10px; border-radius: 4px; margin-bottom: 5px; display: inline-block; margin-left: 5px; /* שינוי ל-margin-left */ }
        .hotels-list-container .hotel-item {
            background-color: #f9f9f9;
            border: 1px solid var(--medium-gray);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }
        .hotels-list-container .hotel-item h5 { margin-top: 0; color: var(--primary-color); }
        .hotels-list-container .hotel-item .affiliate-links-hotel a { margin-left: 10px; /* שינוי ל-margin-left */ margin-bottom: 5px;} /* רווח בין כפתורי המלון */

        #flight-info, #hotel-info, #package-info { margin-top: 20px; }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div id="branding">
                <h1><a href="index.html">✈️ נופש לי ולך</a></h1>
            </div>
            <nav>
                <ul>
                    <li><a href="index.html">דף הבית</a></li>
                    <li><a href="deals.html">כל הדילים</a></li>
                    <li><a href="admin.html">ניהול</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <section id="deal-details-page" class="container">
        <div class="deal-details-container">
            <h2 id="deal-title">טוען את פרטי הדיל...</h2>
            <img id="deal-image" src="https://via.placeholder.com/800x400?text=טוען+תמונה..." alt="תמונת הדיל" style="margin-bottom: 20px;">
            
            <div class="deal-meta-section">
                <h4>סוג דיל: <span id="type-value" style="font-weight:normal;"></span></h4>
                <p id="deal-price" class="price" style="font-size: 1.4em;">מחיר: <span id="price-value"></span></p>
            </div>

            <div id="deal-main-description" class="deal-meta-section">
                 <h4>תיאור הדיל:</h4>
                 <p id="deal-description-text">תיאור מפורט של הדיל יופיע כאן.</p>
            </div>
            
            <div id="trip-types-section" class="deal-meta-section hidden-field">
                <h4>סוגי טיול מתאימים:</h4>
                <ul id="trip-types-list"></ul>
            </div>

            <div id="availability-months-section" class="deal-meta-section hidden-field">
                <h4>חודשי זמינות:</h4>
                <ul id="availability-months-list"></ul>
            </div>

            <div id="specific-deal-info">
                <div id="flight-info" class="hidden-field">
                    <h4>פרטי טיסה:</h4>
                    <p id="flight-notes-text"></p>
                </div>

                <div id="single-hotel-info" class="hidden-field">
                    <h4>פרטי המלון:</h4>
                    </div>
                
                <div id="package-hotels-info" class="hidden-field hotels-list-container">
                    <h4>מלונות המוצעים בחבילה:</h4>
                    <div id="package-hotels-list">
                        </div>
                </div>
            </div>
            
            <div id="booking-options">
                <h3>אפשרויות הזמנה ויצירת קשר</h3>
                <p id="booking-instructions">טוען אפשרויות הזמנה...</p>
            </div>
        </div>
    </section>

    <footer>
        <p>נופש לי ולך &copy; <span id="currentYear"></span></p>
    </footer>

    <script type="module">
        import { db } from './firebase-init.js';
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";

        document.getElementById('currentYear').textContent = new Date().getFullYear();

        const dealTitleEl = document.getElementById('deal-title');
        const dealImageEl = document.getElementById('deal-image');
        const dealDescriptionTextEl = document.getElementById('deal-description-text');
        const priceValueEl = document.getElementById('price-value');
        const typeValueEl = document.getElementById('type-value');
        
        const tripTypesSection = document.getElementById('trip-types-section');
        const tripTypesListEl = document.getElementById('trip-types-list');
        const availabilityMonthsSection = document.getElementById('availability-months-section');
        const availabilityMonthsListEl = document.getElementById('availability-months-list');

        const specificDealInfoContainer = document.getElementById('specific-deal-info');
        const flightInfoSection = document.getElementById('flight-info');
        const flightNotesTextEl = document.getElementById('flight-notes-text');
        const singleHotelInfoSection = document.getElementById('single-hotel-info');
        const packageHotelsInfoSection = document.getElementById('package-hotels-info');
        const packageHotelsListEl = document.getElementById('package-hotels-list');

        const bookingOptionsContainer = document.getElementById('booking-options');
        const bookingInstructionsEl = document.getElementById('booking-instructions');

        // פונקציית עזר להמרת YYYY-MM לשם חודש + שנה
        function formatMonthYear(monthYearString) {
            if (!monthYearString || !monthYearString.includes('-')) return monthYearString;
            const [year, month] = monthYearString.split('-');
            const date = new Date(year, parseInt(month) - 1, 1);
            return date.toLocaleString('he-IL', { month: 'long', year: 'numeric' });
        }
        
        // פונקציית עזר להצגת סוג הדיל בעברית
        function getDealTypeDisplay(dealTypeKey) {
            const types = {
                flight: 'טיסה בלבד',
                hotel: 'מלון בלבד',
                package: 'חבילה (טיסה ומלון/ות)'
            };
            return types[dealTypeKey] || dealTypeKey;
        }


        async function fetchDealDetails() {
            const urlParams = new URLSearchParams(window.location.search);
            const dealId = urlParams.get('dealId');

            if (!dealId) {
                dealTitleEl.textContent = "דיל לא נמצא";
                dealDescriptionTextEl.textContent = "אנא חזור לדף הדילים ובחר דיל.";
                dealImageEl.style.display = 'none';
                bookingInstructionsEl.textContent = '';
                return;
            }

            try {
                const dealRef = doc(db, "deals", dealId);
                const docSnap = await getDoc(dealRef);

                if (docSnap.exists()) {
                    const deal = docSnap.data();
                    document.title = `${deal.name} - נופש לי ולך`; // עדכון כותרת הדף
                    dealTitleEl.textContent = deal.name;
                    dealImageEl.src = deal.imageUrl || 'https://via.placeholder.com/800x400?text=תמונה+לא+זמינה';
                    dealImageEl.alt = deal.name;
                    dealDescriptionTextEl.innerHTML = deal.description ? deal.description.replace(/\n/g, '<br>') : 'אין תיאור זמין.';
                    priceValueEl.textContent = deal.price_text || 'לא צוין';
                    typeValueEl.textContent = getDealTypeDisplay(deal.dealType);

                    // הצגת סוגי טיול
                    if (deal.tripTypes && deal.tripTypes.length > 0) {
                        tripTypesSection.classList.remove('hidden-field');
                        tripTypesListEl.innerHTML = deal.tripTypes.map(type => `<li>${type}</li>`).join('');
                    } else {
                        tripTypesSection.classList.add('hidden-field');
                    }

                    // הצגת חודשי זמינות
                    if (deal.availabilityMonths && deal.availabilityMonths.length > 0) {
                        availabilityMonthsSection.classList.remove('hidden-field');
                        availabilityMonthsListEl.innerHTML = deal.availabilityMonths.map(month => `<li>${formatMonthYear(month)}</li>`).join('');
                    } else {
                        availabilityMonthsSection.classList.add('hidden-field');
                    }

                    // הסתר את כל חלקי המידע הספציפי תחילה
                    flightInfoSection.classList.add('hidden-field');
                    singleHotelInfoSection.classList.add('hidden-field');
                    packageHotelsInfoSection.classList.add('hidden-field');
                    bookingInstructionsEl.innerHTML = ''; // נקה הוראות קודמות

                    // הצג מידע ספציפי ואפשרויות הזמנה לפי סוג הדיל
                    let bookingHtml = '';

                    if (deal.dealType === 'flight') {
                        flightInfoSection.classList.remove('hidden-field');
                        flightNotesTextEl.textContent = deal.flightDetails?.notes || 'לא צוינו פרטי טיסה מיוחדים.';
                        
                        bookingHtml = `
                            <p>להזמנת טיסה זו, אנא פנה אלינו ישירות. אנו נסגור עבורך את ההזמנה בעמלה של 100 ₪ או 5% ממחיר הטיסה (הנמוך מביניהם).</p>
                            <a href="mailto:your-email@example.com?subject=הזמנת טיסה: ${encodeURIComponent(deal.name)}" class="button">פנה אליי לסגירת ההזמנה</a>
                        `;
                    } else if (deal.dealType === 'hotel') {
                        singleHotelInfoSection.classList.remove('hidden-field');
                        let hotelAffiliateLinksHTML = '';
                        if (deal.singleHotelAffiliateLinks) {
                            if (deal.singleHotelAffiliateLinks.booking) {
                                hotelAffiliateLinksHTML += `<a href="${deal.singleHotelAffiliateLinks.booking}" target="_blank" class="button">הזמן לבד דרך Booking.com</a>`;
                            }
                            if (deal.singleHotelAffiliateLinks.agoda) {
                                hotelAffiliateLinksHTML += `<a href="${deal.singleHotelAffiliateLinks.agoda}" target="_blank" class="button button-secondary">הזמן לבד דרך Agoda</a>`;
                            }
                            if (deal.singleHotelAffiliateLinks.expedia) {
                                hotelAffiliateLinksHTML += `<a href="${deal.singleHotelAffiliateLinks.expedia}" target="_blank" class="button">הזמן לבד דרך Expedia</a>`;
                            }
                        }
                        singleHotelInfoSection.innerHTML = hotelAffiliateLinksHTML ? `<h4>הזמן את המלון ישירות:</h4>${hotelAffiliateLinksHTML}` : '<p>לא נמצאו קישורי הזמנה ישירה למלון זה.</p>';
                        
                        bookingHtml = `
                            <p><strong>אפשרות 1: הזמנה עצמאית</strong> (אנחנו מקבלים עמלה קטנה מהשותפים ללא תוספת עלות עבורך) - השתמש בקישורים למעלה.</p>
                            <hr style="margin: 20px 0;">
                            <p><strong>אפשרות 2: שירות אישי שלנו</strong></p>
                            <p>פנה אלינו לסגירה אישית של המלון בעמלה של 100 ₪ או 5% ממחיר המלון (הנמוך מביניהם).</p>
                            <a href="mailto:your-email@example.com?subject=הזמנת מלון: ${encodeURIComponent(deal.name)}" class="button">בקש ממני לסגור לך</a>
                        `;
                    } else if (deal.dealType === 'package') {
                        if (deal.flightDetails?.notes) {
                            flightInfoSection.classList.remove('hidden-field');
                            flightNotesTextEl.textContent = deal.flightDetails.notes;
                        }

                        if (deal.hotels && deal.hotels.length > 0) {
                            packageHotelsInfoSection.classList.remove('hidden-field');
                            packageHotelsListEl.innerHTML = deal.hotels.map(hotel => {
                                let hotelLinks = '';
                                if (hotel.affiliateLinks?.booking) hotelLinks += `<a href="${hotel.affiliateLinks.booking}" target="_blank" class="button">Booking.com</a>`;
                                if (hotel.affiliateLinks?.agoda) hotelLinks += `<a href="${hotel.affiliateLinks.agoda}" target="_blank" class="button button-secondary">Agoda</a>`;
                                if (hotel.affiliateLinks?.expedia) hotelLinks += `<a href="${hotel.affiliateLinks.expedia}" target="_blank" class="button">Expedia</a>`;
                                
                                return `
                                    <div class="hotel-item">
                                        <h5>${hotel.name || 'פרטי מלון'}</h5>
                                        <p>${hotel.description || 'אין תיאור נוסף למלון זה.'}</p>
                                        ${hotelLinks ? `<div class="affiliate-links-hotel"><strong>הזמן מלון זה ישירות:</strong><br>${hotelLinks}</div>` : ''}
                                    </div>
                                `;
                            }).join('');
                        } else {
                            packageHotelsListEl.innerHTML = '<p>לא צוינו מלונות ספציפיים לחבילה זו. פנה אלינו להתאמה אישית.</p>';
                        }
                        
                        bookingHtml = `
                            <p>להזמנת חבילה זו (טיסה + מלון/ות), אנא פנה אלינו ישירות. אנו נסגור עבורך את ההזמנה בעמלה כוללת של 100 ₪ או 5% מהמחיר הכולל של החבילה (הנמוך מביניהם).</p>
                            <p>תוכל להזמין את המלונות גם עצמאית דרך הקישורים למעלה (אם קיימים) ולפנות אלינו לסגירת הטיסה בלבד.</p>
                            <a href="mailto:your-email@example.com?subject=הזמנת חבילה: ${encodeURIComponent(deal.name)}" class="button">פנה אליי לסגירת החבילה</a>
                        `;
                    }

                    bookingInstructionsEl.innerHTML = bookingHtml;

                } else {
                    dealTitleEl.textContent = "דיל לא נמצא";
                    dealDescriptionTextEl.textContent = "לא הצלחנו למצוא את פרטי הדיל המבוקש.";
                    dealImageEl.style.display = 'none';
                    bookingInstructionsEl.textContent = '';
                }
            } catch (error) {
                console.error("Error fetching deal details: ", error);
                dealTitleEl.textContent = "שגיאה בטעינת הדיל";
                dealDescriptionTextEl.textContent = "אירעה שגיאה. נסה לרענן את הדף.";
                dealImageEl.style.display = 'none';
                bookingInstructionsEl.textContent = '';
            }
        }

        fetchDealDetails();
    </script>
</body>
</html>
