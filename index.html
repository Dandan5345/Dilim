<!DOCTYPE html>
<html lang="he">
<head>
    <meta name="agd-partner-manual-verification" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="נופש לי ולך - דורון נקש מוצא לכם את הדילים הטובים ביותר לטיסות, מלונות וחבילות.">
    
    <title>נופש לי ולך - דילים שווים לחופשה המושלמת</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="container">
            <div id="branding">
                <h1><a href="index.html">✈️ נופש לי ולך</a></h1>
            </div>
            <nav>
                <ul>
                    <li class="current"><a href="index.html">דף הבית</a></li>
                    <li><a href="deals.html">כל הדילים</a></li>
                    <li><a href="admin.html">ניהול</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <section id="showcase">
        <div class="container">
            <h1>חופשה בתקציב שלך, בלי להתפשר על החלום!</h1>
            <p>דורון נקש, המומחה שלכם לדילים, ימצא עבורכם את הטיסות, המלונות והחבילות המשתלמות ביותר.</p>
            <a href="#search-banner-container" class="button">מצא את הדיל הבא שלך 👇</a>
        </div>
    </section>

    <section id="search-banner-container"> <div class="container">
            <div id="search-banner">
                <h2>תכנן את החופשה שלך</h2>
                <div class="search-form-grid">
                    <div class="search-field">
                        <label for="search-deal-type">מה מחפשים?</label>
                        <select id="search-deal-type">
                            <option value="all">הכל (ברירת מחדל)</option>
                            <option value="package">דיל משתלם (טיסה + מלון)</option>
                            <option value="flight">טיסה בלבד</option>
                            <option value="hotel">מלונות בלבד</option>
                        </select>
                    </div>

                    <div class="search-field">
                        <label>לאיזה חודשים?</label>
                        <div class="custom-select-wrapper" id="months-select-wrapper">
                            <span class="custom-select-display" id="months-display-text" tabindex="0">בחר חודשים...</span>
                            <div class="custom-select-options" id="filter-availability-months">
                                </div>
                        </div>
                    </div>

                    <div class="search-field">
                        <label>איזה סוג חופשה?</label>
                         <div class="custom-select-wrapper" id="trip-types-select-wrapper">
                            <span class="custom-select-display" id="trip-types-display-text" tabindex="0">בחר סוגי חופשה...</span>
                            <div class="custom-select-options" id="filter-trip-types">
                                </div>
                        </div>
                    </div>
                    
                    <div class="search-field">
                        <label for="search-duration">לכמה זמן?</label>
                        <select id="search-duration">
                            <option value="">כל משך זמן</option>
                            <option value="1-3">1-3 ימים</option>
                            <option value="3-6">3-6 ימים</option>
                            <option value="6-10">6-10 ימים</option>
                            <option value="10-20">10-20 ימים</option>
                        </select>
                    </div>
                    <div class="search-buttons-inline">
                        <button id="apply-search-btn" class="button">🔍 חפש</button>
                        <button id="reset-search-btn" class="button button-secondary">🔄 אפס</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="deals-display-section">
        <div class="container">
            <h2 id="deals-section-title">דילים מומלצים 🔥</h2>
            <div id="deals-list" class="deals-grid">
                <p>טוען דילים...</p>
            </div>
        </div>
    </section>
    
    <section id="about-contact-section">
        <div class="container">
             <div> <h2>מי אני ולמה כדאי לכם לדבר איתי?</h2>
                <p>
                    היי, אני דורון נקש, והתשוקה שלי היא למצוא את הדילים הכי שווים שיש ולהפוך את החופשה הבאה שלכם לחלומית - ובלי לקרוע את הכיס! 
                    עם ניסיון של שנים באיתור הזדמנויות ומבצעים נסתרים, אני כאן כדי לעזור לכם לתכנן כל פרט, לחסוך לכם זמן יקר והרבה כסף, והכי חשוב - לגרום לכם להנות מחופשה מושלמת בראש שקט.
                </p>
                <h3>מעדיפים ליווי אישי או שיש לכם שאלה? דברו איתי!</h3>
                <div class="contact-links">
                    <a href="https://wa.me/972584593847?text=היי%20דורון,%20אשמח%20לסיוע%20במציאת%20דיל%20לחופשה" target="_blank" class="button" style="background-color: #25D366;"><span>שלח הודעה בוואטסאפ</span> 🟢</a>
                    <a href="https://www.instagram.com/nofesh_li?igsh=NjYzMWd6a21tbWdm&utm_source=qr" target="_blank" class="button" style="background: linear-gradient(45deg, #f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%);"><span>עקבו אחרי באינסטגרם</span> 📸</a>
                </div>
                <p style="font-size:1.1em; margin-top:25px; font-weight:600;">טלפון ליצירת קשר: 058-4593847</p>
            </div>
        </div>
    </section>

    <footer>
        <p>נופש לי ולך &copy; <span id="currentYear"></span> | כל הזכויות שמורות לדורון נקש</p>
    </footer>

    <script type="module">
        import { db } from './firebase-init.js';
        import { collection, getDocs, query, orderBy, limit as firestoreLimit } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";

        document.getElementById('currentYear').textContent = new Date().getFullYear();

        const ALL_TRIP_TYPES_WITH_EMOJI = [
            { value: "בטן גב", label: "🏖️ בטן גב" },
            { value: "נופים וטבע", label: "🏞️ נופים וטבע" },
            { value: "עיר אירופאית", label: "🏰 עיר אירופאית" },
            { value: "ארצות הברית", label: "🗽 ארצות הברית" },
            { value: "מזרח רחוק", label: "🏯 מזרח רחוק" },
            { value: "שווקי קריסמס", label: "🎄 שווקי קריסמס" },
            { value: "סקי", label: "⛷️ סקי" },
            { value: "טרקים", label: "🧗 טרקים" },
            { value: "קרוז", label: "🚢 קרוז" },
            { value: "ספארי", label: "🦓 ספארי" },
            { value: "ירח דבש", label: "🥂 ירח דבש" },
            { value: "משפחות", label: "👨‍👩‍👧‍👦 משפחות" }
        ];

        function getNextMonthsAvailability(numberOfMonths = 60) {
            const months = [];
            const currentDate = new Date();
            currentDate.setDate(1);
            let targetYear = currentDate.getFullYear();
            let targetMonth = currentDate.getMonth();

            for (let i = 0; i < numberOfMonths; i++) {
                const date = new Date(targetYear, targetMonth + i, 1);
                if (date.getFullYear() > 2030 || (date.getFullYear() === 2030 && date.getMonth() > 0)) {
                    break;
                }
                const yearVal = date.getFullYear();
                const monthVal = (date.getMonth() + 1).toString().padStart(2, '0');
                const monthName = date.toLocaleString('he-IL', { month: 'long', year: 'numeric' });
                months.push({ value: `${yearVal}-${monthVal}`, label: `${monthName}` });
            }
            return months;
        }
        const AVAILABLE_MONTHS_OPTIONS = getNextMonthsAvailability();
        
        const dealsListContainer = document.getElementById('deals-list');
        const dealsSectionTitle = document.getElementById('deals-section-title');
        
        const filterDealTypeSelect = document.getElementById('search-deal-type');
        const filterDurationSelect = document.getElementById('search-duration');
        
        const monthsSelectWrapper = document.getElementById('months-select-wrapper');
        const monthsDisplayText = document.getElementById('months-display-text');
        const filterAvailabilityMonthsContainer = document.getElementById('filter-availability-months');
        
        const tripTypesSelectWrapper = document.getElementById('trip-types-select-wrapper');
        const tripTypesDisplayText = document.getElementById('trip-types-display-text');
        const filterTripTypesContainer = document.getElementById('filter-trip-types');

        const applySearchBtn = document.getElementById('apply-search-btn');
        const resetSearchBtn = document.getElementById('reset-search-btn');

        let allDealsCache = [];

        function populateCustomDropdownCheckboxes(container, options, groupName, displayElement, defaultText) {
            if (!container || !displayElement) return;
            container.innerHTML = '';
            options.forEach(option => {
                const checkboxId = `filter-index-${groupName}-${option.value.replace(/[^a-zA-Z0-9א-ת\-_]/g, '-')}`;
                const label = document.createElement('label');
                label.htmlFor = checkboxId;
                label.innerHTML = `<input type="checkbox" id="${checkboxId}" name="${groupName}" value="${option.value}"> ${option.label}`;
                container.appendChild(label);
            });
            container.addEventListener('change', () => updateCustomDropdownDisplay(container, displayElement, defaultText, options.length));
        }

        function updateCustomDropdownDisplay(optionsContainer, displayElement, defaultText, totalOptions) {
            if (!optionsContainer || !displayElement) return;
            const selectedCheckboxes = Array.from(optionsContainer.querySelectorAll('input[type="checkbox"]:checked'));
            const selectedLabels = selectedCheckboxes.map(cb => {
                                        const parentLabel = cb.closest('label');
                                        // Extract only the label text, not the value if it's part of the label (it shouldn't be with current setup)
                                        return parentLabel ? cb.nextSibling.textContent.trim() : '';
                                    }).filter(text => text);

            if (selectedLabels.length > 0) {
                 if (selectedLabels.length === totalOptions && totalOptions > 2) {
                     displayElement.textContent = "כל האפשרויות";
                } else if (selectedLabels.length > 2) {
                    displayElement.textContent = `${selectedLabels.slice(0, 2).join(', ')}, ועוד ${selectedLabels.length - 2}`;
                } else {
                    displayElement.textContent = selectedLabels.join(', ');
                }
            } else {
                displayElement.textContent = defaultText;
            }
        }
        
        function setupCustomDropdown(wrapperElement, optionsContainerElement) {
            if (!wrapperElement || !optionsContainerElement) return;
            const displayElement = wrapperElement.querySelector('.custom-select-display');
            if(!displayElement) return;

            function closeOtherDropdowns(exceptThisOne) {
                 document.querySelectorAll('.custom-select-options.active').forEach(activeDropdown => {
                    if (activeDropdown !== exceptThisOne && !exceptThisOne.contains(activeDropdown.parentElement)) {
                        activeDropdown.classList.remove('active');
                    }
                });
            }
            displayElement.addEventListener('click', (event) => {
                event.stopPropagation();
                closeOtherDropdowns(optionsContainerElement);
                optionsContainerElement.classList.toggle('active');
            });
            displayElement.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault(); event.stopPropagation();
                    closeOtherDropdowns(optionsContainerElement);
                    optionsContainerElement.classList.toggle('active');
                }
            });
            optionsContainerElement.addEventListener('click', (event) => {
                event.stopPropagation();
            });
            document.addEventListener('click', (event) => {
                if (optionsContainerElement.classList.contains('active') && !wrapperElement.contains(event.target)) {
                    optionsContainerElement.classList.remove('active');
                }
            });
        }

        populateCustomDropdownCheckboxes(filterAvailabilityMonthsContainer, AVAILABLE_MONTHS_OPTIONS, 'availabilityMonthIndex', monthsDisplayText, "בחר חודשים...");
        setupCustomDropdown(monthsSelectWrapper, filterAvailabilityMonthsContainer);

        populateCustomDropdownCheckboxes(filterTripTypesContainer, ALL_TRIP_TYPES_WITH_EMOJI, 'tripTypeIndex', tripTypesDisplayText, "בחר סוגי חופשה...");
        setupCustomDropdown(tripTypesSelectWrapper, filterTripTypesContainer);

        function displayDeals(dealsToDisplay) {
            if (!dealsListContainer) return;
            dealsListContainer.innerHTML = '';

            if (dealsToDisplay.length === 0) {
                dealsListContainer.innerHTML = '<div style="text-align:center; font-size:1.3em; color:var(--secondary-color); padding: 20px; background-color: #fff; border-radius:8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);"><p>לא נמצאו דילים מומלצים כרגע. 😟</p><p>נסו לחפש או <a href="deals.html" style="color:var(--accent-color); font-weight:bold;">צפו בכל הדילים</a>.</p></div>';
                dealsSectionTitle.textContent = "אין דילים מומלצים כרגע";
                return;
            }

            dealsToDisplay.forEach(dealData => {
                const deal = dealData.data;
                const dealId = dealData.id;
                const dealElement = document.createElement('div');
                dealElement.className = 'deal-item';
                dealElement.innerHTML = `
                    <img src="${deal.imageUrl || 'https://via.placeholder.com/350x230?text=תמונה+לא+זמינה'}" alt="${deal.name || 'דיל'}">
                    <div class="deal-item-content">
                        <h3>${deal.name || 'דיל מיוחד'}</h3>
                        <p class="price">${deal.price_text || 'פנה למחיר'}</p>
                        <p>${deal.description ? deal.description.substring(0, 100) + (deal.description.length > 100 ? '...' : '') : 'פרטים נוספים זמינים בפנייה.'}</p>
                        <a href="deal-details.html?dealId=${dealId}" class="button">פרטים נוספים והזמנה</a>
                    </div>
                `;
                dealsListContainer.appendChild(dealElement);
            });
            dealsSectionTitle.textContent = "דילים מומלצים 🔥";
        }
        
        async function fetchAndDisplayInitialDeals() {
            dealsListContainer.innerHTML = '<p style="text-align:center; font-size:1.2em; padding: 20px;">טוען דילים מומלצים...</p>';
            try {
                if (allDealsCache.length === 0) {
                    const dealsRef = collection(db, 'deals');
                    const q = query(dealsRef, orderBy('createdAt', 'desc')); 
                    const querySnapshot = await getDocs(q);
                    allDealsCache = querySnapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
                }
                const featuredDeals = allDealsCache.slice(0, 5);
                displayDeals(featuredDeals);

            } catch (error) {
                console.error("Error fetching initial deals: ", error);
                dealsListContainer.innerHTML = '<p style="text-align:center; color:red; padding:20px;">שגיאה בטעינת הדילים. אנא רענן את הדף או פנה אלינו.</p>';
                dealsSectionTitle.textContent = "שגיאה בטעינה";
            }
        }
        
        applySearchBtn.addEventListener('click', () => {
            const selectedDealType = filterDealTypeSelect.value;
            const selectedDurationRange = filterDurationSelect.value;
            
            const selectedTripTypes = Array.from(filterTripTypesContainer.querySelectorAll('input[name="tripTypeIndex"]:checked')).map(cb => cb.value);
            const selectedMonths = Array.from(filterAvailabilityMonthsContainer.querySelectorAll('input[name="availabilityMonthIndex"]:checked')).map(cb => cb.value);

            const params = new URLSearchParams();
            if (selectedDealType && selectedDealType !== 'all') {
                params.append('dealType', selectedDealType);
            }
            if (selectedDurationRange) {
                params.append('duration', selectedDurationRange);
            }
            if (selectedTripTypes.length > 0) {
                params.append('tripTypes', selectedTripTypes.join(','));
            }
            if (selectedMonths.length > 0) {
                params.append('months', selectedMonths.join(','));
            }
            
            window.location.href = `deals.html?${params.toString()}`;
        });
        
        resetSearchBtn.addEventListener('click', () => {
            filterDealTypeSelect.value = 'all';
            filterDurationSelect.value = '';
            
            filterTripTypesContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            updateCustomDropdownDisplay(filterTripTypesContainer, tripTypesDisplayText, "בחר סוגי חופשה...", ALL_TRIP_TYPES_WITH_EMOJI.length);
            
            filterAvailabilityMonthsContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            updateCustomDropdownDisplay(filterAvailabilityMonthsContainer, monthsDisplayText, "בחר חודשים...", AVAILABLE_MONTHS_OPTIONS.length);
        });

        fetchAndDisplayInitialDeals();
    </script>
</body>
</html>
