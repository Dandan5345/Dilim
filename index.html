<!DOCTYPE html>
<html lang="he">
<head>
    <meta name="agd-partner-manual-verification" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="× ×•×¤×© ×œ×™ ×•×œ×š - ×“×•×¨×•×Ÿ × ×§×© ××•×¦× ×œ×›× ××ª ×”×“×™×œ×™× ×”×˜×•×‘×™× ×‘×™×•×ª×¨ ×œ×˜×™×¡×•×ª, ××œ×•× ×•×ª ×•×—×‘×™×œ×•×ª.">
    
    <title>× ×•×¤×© ×œ×™ ×•×œ×š - ×“×™×œ×™× ×©×•×•×™× ×œ×—×•×¤×©×” ×”××•×©×œ××ª</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* * ×¨×•×‘ ×”×¢×™×¦×•×‘ ××’×™×¢ ×-style.css ×”×—×™×¦×•× ×™.
         * ×”×¡×’× ×•× ×•×ª ×©×”×™×• ×›××Ÿ ×§×•×“× ×¢×‘×•×¨ header, search-banner ×•×›×•' ×”×•×¢×‘×¨×• ×œ-style.css ×”×¨××©×™.
         * × ×™×ª×Ÿ ×œ×”×©××™×¨ ×›××Ÿ ×¨×§ ×¡×’× ×•× ×•×ª ×¡×•×¤×¨-×¡×¤×¦×™×¤×™×™× ×œ×“×£ ×–×” ×× ×™×© ×¦×•×¨×š, ××š ×›×¨×’×¢ ××™×Ÿ.
        */
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div id="branding">
                <h1><a href="index.html">âœˆï¸ × ×•×¤×© ×œ×™ ×•×œ×š</a></h1>
            </div>
            <nav>
                <ul>
                    <li class="current"><a href="index.html">×“×£ ×”×‘×™×ª</a></li>
                    <li><a href="deals.html">×›×œ ×”×“×™×œ×™×</a></li>
                    <li><a href="admin.html">× ×™×”×•×œ</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <section id="showcase">
        <div class="container">
            <h1>×—×•×¤×©×” ×‘×ª×§×¦×™×‘ ×©×œ×š, ×‘×œ×™ ×œ×”×ª×¤×©×¨ ×¢×œ ×”×—×œ×•×!</h1>
            <p>×“×•×¨×•×Ÿ × ×§×©, ×”××•××—×” ×©×œ×›× ×œ×“×™×œ×™×, ×™××¦× ×¢×‘×•×¨×›× ××ª ×”×˜×™×¡×•×ª, ×”××œ×•× ×•×ª ×•×”×—×‘×™×œ×•×ª ×”××©×ª×œ××•×ª ×‘×™×•×ª×¨.</p>
            <a href="#search-banner-container" class="button">××¦× ××ª ×”×“×™×œ ×”×‘× ×©×œ×š ğŸ‘‡</a>
        </div>
    </section>

    <div id="search-banner-container" class="container">
        <div id="search-banner">
            <h2>×ª×›× ×Ÿ ××ª ×”×—×•×¤×©×” ×©×œ×š</h2>
            <div class="search-form-grid">
                <div class="search-field">
                    <label for="search-deal-type">××” ××—×¤×©×™×?</label>
                    <select id="search-deal-type">
                        <option value="all">×”×›×œ (×‘×¨×™×¨×ª ××—×“×œ)</option>
                        <option value="package">×“×™×œ ××©×ª×œ× (×˜×™×¡×” + ××œ×•×Ÿ)</option>
                        <option value="flight">×˜×™×¡×” ×‘×œ×‘×“</option>
                        <option value="hotel">××œ×•× ×•×ª ×‘×œ×‘×“</option>
                    </select>
                </div>

                <div class="search-field">
                    <label>×œ××™×–×” ×—×•×“×©×™×?</label>
                    <div class="custom-select-wrapper" id="months-select-wrapper">
                        <span class="custom-select-display" id="months-display-text" tabindex="0">×‘×—×¨ ×—×•×“×©×™×...</span>
                        <div class="custom-select-options" id="filter-availability-months">
                            </div>
                    </div>
                </div>

                <div class="search-field">
                    <label>××™×–×” ×¡×•×’ ×—×•×¤×©×”?</label>
                     <div class="custom-select-wrapper" id="trip-types-select-wrapper">
                        <span class="custom-select-display" id="trip-types-display-text" tabindex="0">×‘×—×¨ ×¡×•×’×™ ×—×•×¤×©×”...</span>
                        <div class="custom-select-options" id="filter-trip-types">
                            </div>
                    </div>
                </div>
                
                <div class="search-field">
                    <label for="search-duration">×œ×›××” ×–××Ÿ?</label>
                    <select id="search-duration">
                        <option value="">×›×œ ××©×š ×–××Ÿ</option>
                        <option value="1-3">1-3 ×™××™×</option>
                        <option value="3-6">3-6 ×™××™×</option>
                        <option value="6-10">6-10 ×™××™×</option>
                        <option value="10-20">10-20 ×™××™×</option>
                    </select>
                </div>
                <div class="search-buttons-inline">
                    <button id="apply-search-btn" class="button">ğŸ” ×—×¤×©</button>
                    <button id="reset-search-btn" class="button button-secondary">ğŸ”„ ××¤×¡</button>
                </div>
            </div>
        </div>
    </div>

    <section id="deals-display-section">
        <div class="container">
            <h2 id="deals-section-title">×“×™×œ×™× ××•××œ×¦×™× ğŸ”¥</h2>
            <div id="deals-list" class="deals-grid">
                <p>×˜×•×¢×Ÿ ×“×™×œ×™×...</p>
            </div>
        </div>
    </section>
    
    <section id="about-contact-section">
        <div class="container" style="background-color: #fff; padding: 40px 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); text-align:center;">
            <h2>××™ ×× ×™ ×•×œ××” ×›×“××™ ×œ×›× ×œ×“×‘×¨ ××™×ª×™?</h2>
            <p style="font-size: 1.15em; line-height: 1.9; max-width: 750px; margin: 0 auto 25px auto;">
                ×”×™×™, ×× ×™ ×“×•×¨×•×Ÿ × ×§×©, ×•×”×ª×©×•×§×” ×©×œ×™ ×”×™× ×œ××¦×•× ××ª ×”×“×™×œ×™× ×”×›×™ ×©×•×•×™× ×©×™×© ×•×œ×”×¤×•×š ××ª ×”×—×•×¤×©×” ×”×‘××” ×©×œ×›× ×œ×—×œ×•××™×ª - ×•×‘×œ×™ ×œ×§×¨×•×¢ ××ª ×”×›×™×¡! 
                ×¢× × ×™×¡×™×•×Ÿ ×©×œ ×©× ×™× ×‘××™×ª×•×¨ ×”×–×“×× ×•×™×•×ª ×•××‘×¦×¢×™× × ×¡×ª×¨×™×, ×× ×™ ×›××Ÿ ×›×“×™ ×œ×¢×–×•×¨ ×œ×›× ×œ×ª×›× ×Ÿ ×›×œ ×¤×¨×˜, ×œ×—×¡×•×š ×œ×›× ×–××Ÿ ×™×§×¨ ×•×”×¨×‘×” ×›×¡×£, ×•×”×›×™ ×—×©×•×‘ - ×œ×’×¨×•× ×œ×›× ×œ×”× ×•×ª ××—×•×¤×©×” ××•×©×œ××ª ×‘×¨××© ×©×§×˜.
            </p>
            <h3 style="color: var(--secondary-color); margin-top: 30px; margin-bottom: 15px; font-size: 1.6em; font-weight: 600;">××¢×“×™×¤×™× ×œ×™×•×•×™ ××™×©×™ ××• ×©×™×© ×œ×›× ×©××œ×”? ×“×‘×¨×• ××™×ª×™!</h3>
            <div class="contact-links" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px;">
                <a href="https://wa.me/972584593847?text=×”×™×™%20×“×•×¨×•×Ÿ,%20××©××—%20×œ×¡×™×•×¢%20×‘××¦×™××ª%20×“×™×œ%20×œ×—×•×¤×©×”" target="_blank" class="button" style="background-color: #25D366; display: inline-flex; align-items: center; gap: 8px; font-size:1.1em !important; padding:12px 25px !important;"><span>×©×œ×— ×”×•×“×¢×” ×‘×•×•××˜×¡××¤</span> ğŸŸ¢</a>
                <a href="https://www.instagram.com/nofesh_li?igsh=NjYzMWd6a21tbWdm&utm_source=qr" target="_blank" class="button" style="background: linear-gradient(45deg, #f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%); display: inline-flex; align-items: center; gap: 8px; font-size:1.1em !important; padding:12px 25px !important;"><span>×¢×§×‘×• ××—×¨×™ ×‘××™× ×¡×˜×’×¨×</span> ğŸ“¸</a>
            </div>
            <p style="font-size:1.1em; margin-top:25px; font-weight:600;">×˜×œ×¤×•×Ÿ ×œ×™×¦×™×¨×ª ×§×©×¨: 058-4593847</p>
        </div>
    </section>

    <footer>
        <p>× ×•×¤×© ×œ×™ ×•×œ×š &copy; <span id="currentYear"></span> | ×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª ×œ×“×•×¨×•×Ÿ × ×§×©</p>
    </footer>

    <script type="module">
        import { db } from './firebase-init.js';
        import { collection, getDocs, query, orderBy, limit as firestoreLimit } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";

        document.getElementById('currentYear').textContent = new Date().getFullYear();

        const ALL_TRIP_TYPES_WITH_EMOJI = [
            { value: "×‘×˜×Ÿ ×’×‘", label: "ğŸ–ï¸ ×‘×˜×Ÿ ×’×‘" },
            { value: "× ×•×¤×™× ×•×˜×‘×¢", label: "ğŸï¸ × ×•×¤×™× ×•×˜×‘×¢" },
            { value: "×¢×™×¨ ××™×¨×•×¤××™×ª", label: "ğŸ° ×¢×™×¨ ××™×¨×•×¤××™×ª" },
            { value: "××¨×¦×•×ª ×”×‘×¨×™×ª", label: "ğŸ—½ ××¨×¦×•×ª ×”×‘×¨×™×ª" },
            { value: "××–×¨×— ×¨×—×•×§", label: "ğŸ¯ ××–×¨×— ×¨×—×•×§" },
            { value: "×©×•×•×§×™ ×§×¨×™×¡××¡", label: "ğŸ„ ×©×•×•×§×™ ×§×¨×™×¡××¡" },
            { value: "×¡×§×™", label: "â›·ï¸ ×¡×§×™" },
            { value: "×˜×¨×§×™×", label: "ğŸ§— ×˜×¨×§×™×" },
            { value: "×§×¨×•×–", label: "ğŸš¢ ×§×¨×•×–" },
            { value: "×¡×¤××¨×™", label: "ğŸ¦“ ×¡×¤××¨×™" },
            { value: "×™×¨×— ×“×‘×©", label: "ğŸ¥‚ ×™×¨×— ×“×‘×©" },
            { value: "××©×¤×—×•×ª", label: "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ××©×¤×—×•×ª" }
        ];

        function getNextMonthsAvailability(numberOfMonths = 60) {
            const months = [];
            const currentDate = new Date();
            currentDate.setDate(1);
            let targetYear = currentDate.getFullYear();
            let targetMonth = currentDate.getMonth();

            for (let i = 0; i < numberOfMonths; i++) {
                const date = new Date(targetYear, targetMonth + i, 1);
                if (date.getFullYear() > 2030 || (date.getFullYear() === 2030 && date.getMonth() > 0)) {
                    break;
                }
                const yearVal = date.getFullYear();
                const monthVal = (date.getMonth() + 1).toString().padStart(2, '0');
                const monthName = date.toLocaleString('he-IL', { month: 'long', year: 'numeric' });
                months.push({ value: `${yearVal}-${monthVal}`, label: `${monthName}` });
            }
            return months;
        }
        const AVAILABLE_MONTHS_OPTIONS = getNextMonthsAvailability();
        
        const dealsListContainer = document.getElementById('deals-list');
        const dealsSectionTitle = document.getElementById('deals-section-title');
        
        const filterDealTypeSelect = document.getElementById('search-deal-type');
        const filterDurationSelect = document.getElementById('search-duration');
        
        const monthsSelectWrapper = document.getElementById('months-select-wrapper');
        const monthsDisplayText = document.getElementById('months-display-text');
        const filterAvailabilityMonthsContainer = document.getElementById('filter-availability-months');
        
        const tripTypesSelectWrapper = document.getElementById('trip-types-select-wrapper');
        const tripTypesDisplayText = document.getElementById('trip-types-display-text');
        const filterTripTypesContainer = document.getElementById('filter-trip-types');

        const applySearchBtn = document.getElementById('apply-search-btn'); // ID ×©×•× ×” ××›×¤×ª×•×¨ ×‘-deals.html
        const resetSearchBtn = document.getElementById('reset-search-btn'); // ID ×©×•× ×” ××›×¤×ª×•×¨ ×‘-deals.html

        let allDealsCache = []; // ××©××© ×œ×˜×¢×™× ×” ×¨××©×•× ×™×ª ×•××™×¤×•×¡

        function populateCustomDropdownCheckboxes(container, options, groupName, displayElement, defaultText) {
            if (!container || !displayElement) return;
            container.innerHTML = '';
            options.forEach(option => {
                const checkboxId = `filter-index-${groupName}-${option.value.replace(/[^a-zA-Z0-9×-×ª\-_]/g, '-')}`;
                const label = document.createElement('label');
                label.htmlFor = checkboxId;
                label.innerHTML = `<input type="checkbox" id="${checkboxId}" name="${groupName}" value="${option.value}"> ${option.label}`;
                container.appendChild(label);
            });
            container.addEventListener('change', () => updateCustomDropdownDisplay(container, displayElement, defaultText, options.length));
        }

        function updateCustomDropdownDisplay(optionsContainer, displayElement, defaultText, totalOptions) {
            if (!optionsContainer || !displayElement) return;
            const selectedCheckboxes = Array.from(optionsContainer.querySelectorAll('input[type="checkbox"]:checked'));
            const selectedLabels = selectedCheckboxes.map(cb => {
                                        const parentLabel = cb.closest('label');
                                        return parentLabel ? parentLabel.textContent.trim().replace(cb.value, '').trim() : '';
                                    }).filter(text => text);

            if (selectedLabels.length > 0) {
                 if (selectedLabels.length === totalOptions && totalOptions > 2) {
                     displayElement.textContent = "×›×œ ×”××¤×©×¨×•×™×•×ª";
                } else if (selectedLabels.length > 2) {
                    displayElement.textContent = `${selectedLabels.slice(0, 2).join(', ')}, ×•×¢×•×“ ${selectedLabels.length - 2}`;
                } else {
                    displayElement.textContent = selectedLabels.join(', ');
                }
            } else {
                displayElement.textContent = defaultText;
            }
        }
        
        function setupCustomDropdown(wrapperElement, optionsContainerElement) {
            if (!wrapperElement || !optionsContainerElement) return;
            const displayElement = wrapperElement.querySelector('.custom-select-display');
            if(!displayElement) return;

            function closeOtherDropdowns(exceptThisOne) {
                 document.querySelectorAll('.custom-select-options.active').forEach(activeDropdown => {
                    if (activeDropdown !== exceptThisOne && !exceptThisOne.contains(activeDropdown.parentElement)) {
                        activeDropdown.classList.remove('active');
                    }
                });
            }
            displayElement.addEventListener('click', (event) => {
                event.stopPropagation();
                closeOtherDropdowns(optionsContainerElement);
                optionsContainerElement.classList.toggle('active');
            });
            displayElement.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault(); event.stopPropagation();
                    closeOtherDropdowns(optionsContainerElement);
                    optionsContainerElement.classList.toggle('active');
                }
            });
            optionsContainerElement.addEventListener('click', (event) => {
                event.stopPropagation();
            });
            document.addEventListener('click', (event) => {
                if (optionsContainerElement.classList.contains('active') && !wrapperElement.contains(event.target)) {
                    optionsContainerElement.classList.remove('active');
                }
            });
        }

        populateCustomDropdownCheckboxes(filterAvailabilityMonthsContainer, AVAILABLE_MONTHS_OPTIONS, 'availabilityMonthIndex', monthsDisplayText, "×‘×—×¨ ×—×•×“×©×™×...");
        setupCustomDropdown(monthsSelectWrapper, filterAvailabilityMonthsContainer);

        populateCustomDropdownCheckboxes(filterTripTypesContainer, ALL_TRIP_TYPES_WITH_EMOJI, 'tripTypeIndex', tripTypesDisplayText, "×‘×—×¨ ×¡×•×’×™ ×—×•×¤×©×”...");
        setupCustomDropdown(tripTypesSelectWrapper, filterTripTypesContainer);

        function displayDeals(dealsToDisplay) { // ×¤×•× ×§×¦×™×” ×–×• ××¦×™×’×” ×“×™×œ×™×, ×œ×œ× ×§×©×¨ ×× ×”× ××¡×•× × ×™× ××• ××•××œ×¦×™×
            if (!dealsListContainer) return;
            dealsListContainer.innerHTML = '';

            if (dealsToDisplay.length === 0) {
                dealsListContainer.innerHTML = '<p style="text-align:center; font-size:1.2em; color:var(--secondary-color);">×œ× × ××¦××• ×“×™×œ×™× ×›×¨×’×¢. × ×¡×• ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨!</p>';
                dealsSectionTitle.textContent = "××™×Ÿ ×“×™×œ×™× ××•××œ×¦×™× ×›×¨×’×¢";
                return;
            }

            dealsToDisplay.forEach(dealData => {
                const deal = dealData.data;
                const dealId = dealData.id;
                const dealElement = document.createElement('div');
                dealElement.className = 'deal-item';
                dealElement.innerHTML = `
                    <img src="${deal.imageUrl || 'https://via.placeholder.com/350x230?text=×ª××•× ×”+×œ×+×–××™× ×”'}" alt="${deal.name || '×“×™×œ'}">
                    <div class="deal-item-content">
                        <h3>${deal.name || '×“×™×œ ××™×•×—×“'}</h3>
                        <p class="price">${deal.price_text || '×¤× ×” ×œ××—×™×¨'}</p>
                        <p>${deal.description ? deal.description.substring(0, 100) + (deal.description.length > 100 ? '...' : '') : '×¤×¨×˜×™× × ×•×¡×¤×™× ×–××™× ×™× ×‘×¤× ×™×™×”.'}</p>
                        <a href="deal-details.html?dealId=${dealId}" class="button">×¤×¨×˜×™× × ×•×¡×¤×™× ×•×”×–×× ×”</a>
                    </div>
                `;
                dealsListContainer.appendChild(dealElement);
            });
             // ×”×›×•×ª×¨×ª × ×©××¨×ª "×“×™×œ×™× ××•××œ×¦×™× ğŸ”¥" ×•×œ× ××©×ª× ×” ×œ×¤×™ ×ª×•×¦××•×ª ×¡×™× ×•×Ÿ ×›×™ ×”×¡×™× ×•×Ÿ ××¤× ×”
            dealsSectionTitle.textContent = "×“×™×œ×™× ××•××œ×¦×™× ğŸ”¥";
        }
        
        async function fetchAndDisplayInitialDeals() {
            dealsListContainer.innerHTML = '<p style="text-align:center; font-size:1.2em;">×˜×•×¢×Ÿ ×“×™×œ×™× ××•××œ×¦×™×...</p>';
            try {
                if (allDealsCache.length === 0) { // ×˜×¢×Ÿ ×¤×¢× ××—×ª ××ª ×›×œ ×”×“×™×œ×™× ×•×©××•×¨ ×‘××˜××•×Ÿ
                    const dealsRef = collection(db, 'deals');
                    const q = query(dealsRef, orderBy('createdAt', 'desc')); 
                    const querySnapshot = await getDocs(q);
                    allDealsCache = querySnapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
                }
                // ×”×¦×’ ××ª 5 ×”×“×™×œ×™× ×”×¨××©×•× ×™× (×”×›×™ ×—×“×©×™×) ×›×“×™×œ×™× ××•××œ×¦×™×
                const featuredDeals = allDealsCache.slice(0, 5);
                displayDeals(featuredDeals);

            } catch (error) {
                console.error("Error fetching initial deals: ", error);
                dealsListContainer.innerHTML = '<p style="text-align:center; color:red;">×©×’×™××” ×‘×˜×¢×™× ×ª ×”×“×™×œ×™×. ×× × ×¨×¢× ×Ÿ ××ª ×”×“×£ ××• ×¤× ×” ××œ×™× ×•.</p>';
                dealsSectionTitle.textContent = "×©×’×™××” ×‘×˜×¢×™× ×”";
            }
        }
        
        applySearchBtn.addEventListener('click', () => {
            const selectedDealType = filterDealTypeSelect.value;
            const selectedDurationRange = filterDurationSelect.value;
            
            const selectedTripTypes = Array.from(filterTripTypesContainer.querySelectorAll('input[name="tripTypeIndex"]:checked')).map(cb => cb.value);
            const selectedMonths = Array.from(filterAvailabilityMonthsContainer.querySelectorAll('input[name="availabilityMonthIndex"]:checked')).map(cb => cb.value);

            const params = new URLSearchParams();
            if (selectedDealType && selectedDealType !== 'all') {
                params.append('dealType', selectedDealType);
            }
            if (selectedDurationRange) {
                params.append('duration', selectedDurationRange);
            }
            if (selectedTripTypes.length > 0) {
                params.append('tripTypes', selectedTripTypes.join(','));
            }
            if (selectedMonths.length > 0) {
                params.append('months', selectedMonths.join(','));
            }
            
            if (params.toString() === "") { // ×× ×œ× × ×‘×—×¨×• ××¡× × ×™× ×›×œ×œ
                 // ××¤×©×¨ ×œ×”×¦×™×’ ×”×•×“×¢×” ×œ××©×ª××© ×œ×‘×—×•×¨ ××¡× × ×™× ××• ×¤×©×•×˜ ×œ×”×¤× ×•×ª ×œ×“×£ ×”×“×™×œ×™× ×”×›×œ×œ×™
                 window.location.href = 'deals.html'; 
            } else {
                window.location.href = `deals.html?${params.toString()}`;
            }
        });
        
        resetSearchBtn.addEventListener('click', () => {
            filterDealTypeSelect.value = 'all';
            filterDurationSelect.value = '';
            
            filterTripTypesContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            updateCustomDropdownDisplay(filterTripTypesContainer, tripTypesDisplayText, "×‘×—×¨ ×¡×•×’×™ ×—×•×¤×©×”...", ALL_TRIP_TYPES_WITH_EMOJI.length);
            
            filterAvailabilityMonthsContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            updateCustomDropdownDisplay(filterAvailabilityMonthsContainer, monthsDisplayText, "×‘×—×¨ ×—×•×“×©×™×...", AVAILABLE_MONTHS_OPTIONS.length);
            
            // ××™×Ÿ ×¦×•×¨×š ×œ×˜×¢×•×Ÿ ××—×“×© ××ª ×”×“×™×œ×™× ×”××•××œ×¦×™× ×›××Ÿ, ×”× ×›×‘×¨ ××•×¦×’×™×. 
            // ×”××™×¤×•×¡ ×”×•× ×¨×§ ×©×œ ×©×“×•×ª ×”×—×™×¤×•×©.
        });

        // ×˜×¢×™× ×” ×¨××©×•× ×™×ª ×©×œ ×”×“×™×œ×™× ×”××•××œ×¦×™×
        fetchAndDisplayInitialDeals();

    </script>
</body>
</html>
